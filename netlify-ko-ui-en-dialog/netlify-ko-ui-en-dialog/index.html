<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>(ì±… ì´ë¦„) í¼í”„ë¦¬í—¨ì…˜ ì²µì—… ì•¤ ë””ìŠ¤ì»¤ìŠ¤</title>
<link rel="icon" type="image/svg+xml"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'%3E%3Ctext y='.9em' font-size='96'%3E%F0%9F%93%98%3C/text%3E%3C/svg%3E">
<style>
  :root{--accent:#2563eb;--good:#10b981;--warn:#f59e0b;--danger:#ef4444;--ink:#0f172a;--muted:#6b7280}
  *{box-sizing:border-box}
  body{font-family:system-ui,Apple SD Gothic Neo,Malgun Gothic,Arial;margin:0;background:#fff;color:var(--ink);display:flex;min-height:100vh;align-items:center;justify-content:center}
  .box{max-width:980px;width:100%;padding:20px}
  h1{font-size:20px;margin:0 0 8px}
  .muted{color:var(--muted);font-size:12px}
  .row{display:flex;gap:8px;margin:10px 0;flex-wrap:wrap;align-items:center}
  .btn{border:0;border-radius:10px;padding:12px 14px;font-weight:700;cursor:pointer;color:#fff;background:#111}
  .btn.secondary{background:#e5e7eb;color:#111}
  .select{border:1px solid #e5e7eb;border-radius:8px;padding:8px 10px;font-size:14px}
  .status{font-size:13px;color:#111;height:20px;margin-top:6px;display:flex;align-items:center;gap:8px}
  .badge{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:6px 10px;font-weight:700;font-size:12px}
  .idleB{background:#e5e7eb}.listenB{background:#dbeafe}.thinkB{background:#fef3c7}.speakB{background:#dcfce7}
  .bubble{background:#eef3ff;padding:12px;border-radius:12px;line-height:1.45;min-height:54px;margin-top:8px}
  .chatlayout{display:grid;grid-template-columns:280px 1fr;gap:14px;align-items:start}
  .hud{border:1px solid #e5e7eb;border-radius:14px;padding:12px}
  .chatlog{max-height:46vh;overflow:auto;border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#f8fafc}
  .utter{margin:6px 0}.who{font-weight:700}.u{color:#0d9488}.b{color:#1d4ed8}
  .panel{margin-top:12px;border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#ffffff}
  textarea{width:100%;min-height:120px;border:1px solid #e5e7eb;border-radius:8px;padding:8px;font-family:monospace}
  .timerWrap{display:grid;place-items:center;margin:8px 0}
  .ring{width:160px;height:160px;border-radius:50%;background:conic-gradient(var(--accent) 0deg, #e5e7eb 0deg)}
  .ringInner{display:grid;place-items:center;width:140px;height:140px;border-radius:50%;background:#fff;margin:10px auto}
  .timeText{font-size:28px;font-weight:800;letter-spacing:1px}
  .label{font-size:12px;color:var(--muted)}
  .wave{display:flex;gap:3px;height:22px;align-items:flex-end}
  .bar{width:4px;background:#2563eb;border-radius:2px;animation:up 1s infinite ease-in-out}
  .bar:nth-child(2){animation-delay:0.1s}.bar:nth-child(3){animation-delay:0.2s}.bar:nth-child(4){animation-delay:0.3s}.bar:nth-child(5){animation-delay:0.4s}
  @keyframes up{0%,100%{height:4px}50%{height:22px}}
  .toast{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:10px;font-size:13px;display:none}
  .toast.show{display:block}
</style>
</head>
<body>
<div class="box">
  <h1 id="title">(ì±… ì´ë¦„) í¼í”„ë¦¬í—¨ì…˜ ì²µì—… ì•¤ ë””ìŠ¤ì»¤ìŠ¤</h1>
  <div class="muted">ëŒ€í™”ëŠ” ì˜ì–´ë¡œ ì§„í–‰ë˜ë©°, í™”ë©´ í‘œì‹œëŠ” í•œê¸€ì…ë‹ˆë‹¤. SafariëŠ” <b>Samantha</b>, Chromeì€ <b>Google US English</b> ìŒì„±ìœ¼ë¡œ ì½ìŠµë‹ˆë‹¤.</div>

  <div class="row">
    <button id="start" class="btn">â–¶ ì‹œì‘</button>
    <button id="listen-toggle" class="btn">ğŸŸ¢ ë‹µë³€í•˜ê¸° ì‹œì‘</button>
    <button id="repeat" class="btn secondary">âŸ³ ë‹¤ì‹œ ë“£ê¸°</button>
    <button id="end" class="btn secondary">â¹ ì¢…ë£Œ</button>
    <label class="muted" for="voiceSel">ëª©ì†Œë¦¬:</label>
    <select id="voiceSel" class="select"></select>
  </div>

  <div class="chatlayout">
    <div class="hud" aria-live="polite">
      <div class="label">ë‚¨ì€ ì‹œê°„</div>
      <div class="timerWrap">
        <div class="ring" id="ring"><div class="ringInner">
          <div class="timeText" id="time">05:00</div>
        </div></div>
      </div>
      <div class="label">ìƒíƒœ</div>
      <div class="status" id="status">
        <span class="badge idleB" id="stateBadge">ğŸŸ¡ ëŒ€ê¸°ì¤‘</span>
        <div class="wave" id="wave" style="display:none"><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div></div>
      </div>
      <div class="muted" id="turns-left"></div>
    </div>

    <div>
      <div class="bubble" id="bot">ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
      <div class="chatlog" id="log"></div>
      <div class="panel">
        <div class="muted">ì„¸ì…˜ ìš”ì•½(ì‚¬ìš©ì í´ë¦­ ì‹œ ìƒì„±)</div>
        <textarea id="summary" readonly></textarea>
        <div class="row">
          <button id="download" class="btn secondary">â¬‡ ìš”ì•½ ë‹¤ìš´ë¡œë“œ</button>
          <button id="clear" class="btn secondary">ğŸ—‘ ì§€ìš°ê¸°</button>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="toast" id="toast">Connection failed. Please try again later.</div>

<script>
/* ====== ì—˜ë¦¬ë¨¼íŠ¸ ====== */
const startBtn=document.getElementById('start');
const listenBtn=document.getElementById('listen-toggle');
const repeatBtn=document.getElementById('repeat');
const endBtn=document.getElementById('end');
const stateBadge=document.getElementById('stateBadge');
const waveEl=document.getElementById('wave');
const botEl=document.getElementById('bot');
const logEl=document.getElementById('log');
const summaryEl=document.getElementById('summary');
const timeEl=document.getElementById('time');
const ringEl=document.getElementById('ring');
const voiceSel=document.getElementById('voiceSel');
const toastEl=document.getElementById('toast');
const titleEl=document.getElementById('title');
const downloadBtn=document.getElementById('download');
const clearBtn=document.getElementById('clear');

/* ====== ìƒíƒœ ====== */
let recognizing=false, rec=null, mode='IDLE', started=false;
let inFlight=false;
let pendingUtter="";
let history=[]; let lastQuestion="";
let sessionId=(Math.random().toString(36).slice(2)+Date.now().toString(36));

/* ====== ì±…/ì§ˆë¬¸ (í•˜ë“œì½”ë”© â†’ ë‚˜ì¤‘ì—” DB ì—°ë™) ====== */
let book = { title: "ì±… ì´ë¦„", summary:"", chapter:"", characters:"", vocab:"" };
document.title = `(${book.title}) í¼í”„ë¦¬í—¨ì…˜ ì²µì—… ì•¤ ë””ìŠ¤ì»¤ìŠ¤`;
titleEl.textContent = `(${book.title}) í¼í”„ë¦¬í—¨ì…˜ ì²µì—… ì•¤ ë””ìŠ¤ì»¤ìŠ¤`;

// ê¸°ë³¸ 5ë¬¸í•­(ì—†ìœ¼ë©´ free ëª¨ë“œë¡œ ì‹œì‘)
let questionList = [
  "Who is the main character? Try to use 'because' in your answer.",
  "Where and how do the main characters meet?",
  "What problem does the character face inside?",
  "Which moment felt most important to you, and why?",
  "If you were the main character, what would you do next?"
];

let phase = questionList.length ? 'guided' : 'free';
let qIndex = 0;

/* ====== ë³´ì´ìŠ¤ ====== */
let selectedVoice=null;
function isSafari(){ return /^((?!chrome|android).)*safari/i.test(navigator.userAgent); }
function showToast(){ toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'),2000); }
function loadVoices(){
  const voices=speechSynthesis.getVoices();
  voiceSel.innerHTML="";
  voices.filter(v=>v.lang&&v.lang.startsWith('en')).forEach(v=>{
    const opt=document.createElement('option'); opt.value=v.name; opt.textContent=`${v.name} (${v.lang})`; voiceSel.appendChild(opt);
  });
}
voiceSel.addEventListener('change',()=>{
  const voices=speechSynthesis.getVoices();
  selectedVoice=voices.find(v=>v.name===voiceSel.value)||selectedVoice;
});
async function waitForVoices(timeout=1500){
  return new Promise(resolve=>{
    const start=Date.now();
    const id=setInterval(()=>{
      const v=speechSynthesis.getVoices();
      if(v && v.length){ clearInterval(id); resolve(v); }
      else if(Date.now()-start>timeout){ clearInterval(id); resolve(v); }
    },60);
  });
}
async function initVoicesOnce(){
  const voices=await waitForVoices();
  loadVoices();
  const pick=
    (isSafari()
      ? voices.find(v=>v.name==='Samantha' && v.lang.startsWith('en'))
      : voices.find(v=>v.name==='Google US English' && v.lang.startsWith('en')))
    || voices.find(v=>v.lang==='en-US')
    || voices.find(v=>v.lang && v.lang.startsWith('en'))
    || voices[0];
  selectedVoice = pick || null;
  if(selectedVoice){
    const idx=[...voiceSel.options].findIndex(o=>o.value===selectedVoice.name);
    if(idx>=0) voiceSel.selectedIndex=idx;
  }
}
document.addEventListener('DOMContentLoaded', initVoicesOnce);

/* ====== ë°°ì§€/ì½ì–´ì£¼ê¸° ====== */
function setBadge(t){
  if(t==='IDLE'){stateBadge.textContent='ğŸŸ¡ ëŒ€ê¸°ì¤‘';stateBadge.className='badge idleB';waveEl.style.display='none';}
  if(t==='LISTENING'){stateBadge.textContent='ğŸ¤ ë“£ëŠ” ì¤‘';stateBadge.className='badge listenB';waveEl.style.display='flex';}
  if(t==='THINKING'){stateBadge.textContent='ğŸ¤” ìƒê° ì¤‘';stateBadge.className='badge thinkB';waveEl.style.display='none';}
  if(t==='SPEAKING'){stateBadge.textContent='ğŸ—£ï¸ ë§í•˜ëŠ” ì¤‘';stateBadge.className='badge speakB';waveEl.style.display='none';}
}
function setMode(m){ mode=m; setBadge(m); }
function speak(text){
  setMode('SPEAKING');
  const u=new SpeechSynthesisUtterance(text);
  u.lang='en-US';
  if(selectedVoice) u.voice=selectedVoice;
  u.onend=()=>setMode('IDLE');
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}
function say(text){ botEl.textContent=text; speak(text); addLog('assistant', text); }
function addLog(role,text){
  const d=document.createElement('div'); d.className='utter';
  const w=document.createElement('span'); w.className='who '+(role==='assistant'?'b':'u'); w.textContent=role==='assistant'?'Bot: ':'You: ';
  const m=document.createElement('span'); m.textContent=text;
  d.appendChild(w); d.appendChild(m); logEl.appendChild(d); logEl.scrollTop=logEl.scrollHeight;
}

/* ====== íƒ€ì´ë¨¸(5ë¶„) ====== */
const DURATION=300; let startTs=null; let timerHandle=null;
function secondsLeft(){ if(!startTs) return DURATION; const e=Math.floor((Date.now()-startTs)/1000); return Math.max(0,DURATION-e); }
function fmt(s){ const m=Math.floor(s/60), ss=s%60; return `${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}`; }
function setProgress(sec){
  const pct=(sec/DURATION); const deg=Math.max(0,Math.min(360,Math.floor(pct*360)));
  ringEl.style.background=`conic-gradient(var(--accent) ${deg}deg,#e5e7eb ${deg}deg)`;
  if(sec<=10) ringEl.style.background=`conic-gradient(var(--danger) ${deg}deg,#fde2e2 ${deg}deg)`;
  timeEl.textContent=fmt(sec);
}
function startCountdown(){
  if(!startTs){ startTs=Date.now(); localStorage.setItem('hbc_timer_start',String(startTs)); }
  if(timerHandle) clearInterval(timerHandle);
  setProgress(secondsLeft());
  timerHandle=setInterval(()=>{
    const left=secondsLeft(); setProgress(left);
    if(left<=0){
      clearInterval(timerHandle);
      say("Time is up. Session ended. Use 'ìš”ì•½ ë‹¤ìš´ë¡œë“œ' to save a summary.");
      stopCountdown();
      localStorage.removeItem('hbc_timer_start');
      listenBtn.disabled=true;
    }
  },1000);
}
(function restoreTimer(){ const t=localStorage.getItem('hbc_timer_start'); if(t){ startTs=parseInt(t,10); startCountdown(); } })();
const saved=localStorage.getItem('hbc_summary'); if(saved) summaryEl.value=saved;
function stopCountdown(){ if(timerHandle) clearInterval(timerHandle); timerHandle=null; }

/* ====== ì„œë²„ í˜¸ì¶œ ====== */
async function callAI(userText){
  if (inFlight) return;
  inFlight = true;
  setMode('THINKING');

  const recent = history.slice(-12);

  try {
    const res = await fetch('/.netlify/functions/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        history: recent,
        user: userText,
        sessionId,
        book,
        // í˜„ì¬ ì§ˆë¬¸ê³¼ ë‚¨ì€ ì§ˆë¬¸ì„ í•¨ê»˜ ì „ë‹¬
        current_question: lastQuestion || (questionList[qIndex] || ""),
        remainingQuestions: questionList.slice(qIndex)
      })
    });

    const raw = await res.text();

    if (!res.ok) {
      if (res.status === 429 && /insufficient_quota/i.test(raw)) {
        say("Billing credits are depleted. Please recharge and try again.");
      } else {
        say("Connection failed. Please try again later.");
        showToast();
      }
      return;
    }

    function extractBotFields(rawText){
      try{
        const j = JSON.parse(rawText);
        if (j.bot_text || j.next_question) return j;
        const content = j?.choices?.[0]?.message?.content;
        if (typeof content === 'string'){
          try{
            const inner = JSON.parse(content);
            if (inner.bot_text || inner.next_question) return inner;
            return { bot_text: content, next_question: "" };
          }catch{
            return { bot_text: content, next_question: "" };
          }
        }
      }catch{}
      return { bot_text: rawText, next_question: "" };
    }

    const data = extractBotFields(raw);
    const botText = data.bot_text || "";
    const tip     = data.practice_tip ? (" " + data.practice_tip) : "";
    const nextQ   = data.next_question || "";
    lastQuestion  = nextQ || lastQuestion;

    // í”¼ë“œë°± + ë‹¤ìŒ ì§ˆë¬¸ì„ í•¨ê»˜ ë§í•˜ê¸°
    const speakText = nextQ ? `${botText}${tip ? ' '+tip : ''} ${nextQ}`
                            : `${botText}${tip ? ' '+tip : ''}`;
    say(speakText);
    history.push({ role:'assistant', content: speakText });

    // advance=true ì¼ ë•Œë§Œ ë‹¤ìŒ ì§ˆë¬¸ìœ¼ë¡œ ì§„í–‰
    if (data.advance && phase === 'guided' && qIndex < questionList.length) {
      qIndex++;
      if (qIndex >= questionList.length) {
        phase = 'free';
        const kickoff = "Great job! We've finished the questions. Now let's discuss freely â€” what part surprised you the most?";
        lastQuestion = "What part surprised you the most?";
        say(kickoff);
        history.push({ role:'assistant', content: kickoff });
      }
    }
  } catch (e) {
    console.error(e);
    say("Connection failed. Please try again later.");
    showToast();
  } finally {
    inFlight = false;
  }
}

/* ====== ìë™ ì¸ì‹(í† ê¸€) ====== */
const AUTO_SILENCE_MS = 1200;   // ì¹¨ë¬µ ì‹œ ì „ì†¡
const MAX_UTTER_MS    = 12000;  // í•œ ë©ì–´ë¦¬ ìµœëŒ€ ê¸¸ì´
const MIN_WORDS       = 3;      // ë„ˆë¬´ ì§§ìœ¼ë©´ ë¬´ì‹œ
const COOLDOWN_MS     = 1200;   // ì—°ì† í˜¸ì¶œ ì¿¨ë‹¤ìš´
const TURN_BUDGET     = 10;     // ì„¸ì…˜ë‹¹ ì‘ë‹µ í•œë„

let isListening=false;
let silenceTimer=null, maxTimer=null;
let lastCallAt=0, turnsLeft=TURN_BUDGET;

function showTurnsLeft(){
  const el=document.getElementById('turns-left');
  el.textContent=`ë‚¨ì€ AI ì‘ë‹µ: ${turnsLeft}`;
}
showTurnsLeft();

function clearTimers(){ if(silenceTimer){clearTimeout(silenceTimer);silenceTimer=null;} if(maxTimer){clearTimeout(maxTimer);maxTimer=null;} }
function armTimers(){ clearTimers(); silenceTimer=setTimeout(commitUtterance, AUTO_SILENCE_MS); maxTimer=setTimeout(commitUtterance, MAX_UTTER_MS); }

function createRecognizer(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){ botEl.textContent='ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•Šì•„ìš”. Chromeì„ ê¶Œì¥í•©ë‹ˆë‹¤.'; return null; }
  const r=new SR();
  r.lang='en-US';
  r.interimResults=false;
  r.continuous=true;

  r.onstart=()=>{ recognizing=true; pendingUtter=""; setMode('LISTENING'); armTimers(); };
  r.onresult=(e)=>{
    const last=e.results[e.results.length-1];
    if(last && last.isFinal){ pendingUtter += (pendingUtter?" ":"") + last[0].transcript.trim(); }
    armTimers();
  };
  r.onerror =()=>{ recognizing=false; setMode('IDLE'); clearTimers(); showToast(); };
  r.onend   =()=>{ recognizing=false; setMode('IDLE'); clearTimers(); if(isListening){ setTimeout(()=>{ try{ r.start(); }catch{} }, 200); } };
  return r;
}

listenBtn.onclick = () => {
  if(!isListening){
    if(!rec) rec=createRecognizer();
    if(!rec) return;
    try{ rec.start(); }catch{}
    isListening=true;
    listenBtn.textContent='â¹ ì¸ì‹ ì¤‘ì§€';
  }else{
    try{ rec.stop(); }catch{}
    isListening=false;
    listenBtn.textContent='ğŸŸ¢ ë‹µë³€í•˜ê¸° ì‹œì‘';
  }
};

async function commitUtterance(){
  clearTimers();
  const utter=(pendingUtter||"").trim();
  pendingUtter="";

  const words=utter.split(/\s+/).filter(Boolean);
  if(words.length<MIN_WORDS) return;

  if(turnsLeft<=0){ say("AI response limit reached for this session."); return; }
  const now=Date.now();
  if(now-lastCallAt<COOLDOWN_MS) return;
  lastCallAt=now;
  turnsLeft--; showTurnsLeft();

  try {
    addLog('user', utter);
    history.push({ role:'user', content: utter });
    await callAI(utter);
  } catch (e) {
    console.error(e);
    turnsLeft++; showTurnsLeft(); // ì‹¤íŒ¨ ì‹œ ë³µì›(ì„ íƒ)
  }

  if(isListening && rec){ setMode('LISTENING'); armTimers(); }
}

/* ====== ì²« ì§ˆë¬¸ ë¡œì»¬ ì•ˆë‚´(ì„ íƒ) ====== */
function askNextQuestionOnce(){
  if(phase!=='guided') return;
  if(qIndex>=questionList.length){ phase='free'; return; }
  const q = questionList[qIndex];
  lastQuestion = typeof q==='string' ? q : (q?.text ?? String(q));
  const ask = `Question ${qIndex+1}. ${lastQuestion}`;
  addLog('assistant', ask); speak(ask);
}

/* ====== ë²„íŠ¼ ====== */
startBtn.onclick=async ()=>{
  if(started){ say("Youâ€™ve already started. Weâ€™ll keep going."); return; }
  if(speechSynthesis.getVoices().length===0) await initVoicesOnce();
  started=true; startCountdown();
  const greeting="Hello! You have five minutes. I will give short feedback and follow-up questions. Let's begin!";
  history.push({role:'assistant',content:greeting});
  say(greeting);
  askNextQuestionOnce(); // ì²« ì§ˆë¬¸ ì•ˆë‚´
};
repeatBtn.onclick=()=>{ if(lastQuestion){ say("I will repeat: "+lastQuestion); } };
endBtn.onclick   =()=>{ say("Session ended. Click 'ìš”ì•½ ë‹¤ìš´ë¡œë“œ' if you want a summary."); stopCountdown(); };

/* ====== ìš”ì•½ ë‹¤ìš´ë¡œë“œ(ì˜µì…˜) ====== */
downloadBtn.onclick = async () => {
  const transcript = history.map(h => `${h.role==='assistant'?'Bot':'You'}: ${h.content}`).join('\n');
  if(!transcript || transcript.trim().length<10){ alert('There isnâ€™t enough content to summarize.'); return; }

  downloadBtn.disabled = true;
  try{
    const res = await fetch('/.netlify/functions/summarize', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ transcript, maxWords: 250, lang: 'ko' })
    });
    const raw = await res.text();
    if(!res.ok){ console.error('Summarize error', res.status, raw); alert('Summary failed'); return; }

    let out;
    try{ const data=JSON.parse(raw); out = data.choices?.[0]?.message?.content?.trim() || raw; }
    catch{ out = raw; }

    const stamp = new Date().toISOString().replace(/[:.]/g,'-');
    downloadTextFile(out, `summary-${stamp}.md`);
  }catch(e){
    console.error(e); alert('Network error');
  }finally{
    downloadBtn.disabled=false;
  }
};
clearBtn.onclick=()=>{ summaryEl.value=""; localStorage.removeItem('hbc_summary'); };

function downloadTextFile(text, filename){
  const blob = new Blob([text], { type:'text/markdown;charset=utf-8' });
  const url  = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>
