<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>(책 이름) 큼프리헨션 첵업 앤 디스커스</title>
<link rel="icon" type="image/svg+xml"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'%3E%3Ctext y='.9em' font-size='96'%3E%F0%9F%93%98%3C/text%3E%3C/svg%3E">
<style>
  :root{--accent:#2563eb;--good:#10b981;--warn:#f59e0b;--danger:#ef4444;--ink:#0f172a;--muted:#6b7280}
  *{box-sizing:border-box}
  body{font-family:system-ui,Apple SD Gothic Neo,Malgun Gothic,Arial;margin:0;background:#fff;color:var(--ink);display:flex;min-height:100vh;align-items:center;justify-content:center}
  .box{max-width:980px;width:100%;padding:20px}
  h1{font-size:20px;margin:0 0 8px}
  .muted{color:var(--muted);font-size:12px}
  .row{display:flex;gap:8px;margin:10px 0;flex-wrap:wrap;align-items:center}
  .btn{border:0;border-radius:10px;padding:12px 14px;font-weight:700;cursor:pointer;color:#fff;background:#111}
  .btn.secondary{background:#e5e7eb;color:#111}
  .select{border:1px solid #e5e7eb;border-radius:8px;padding:8px 10px;font-size:14px}
  .status{font-size:13px;color:#111;height:20px;margin-top:6px;display:flex;align-items:center;gap:8px}
  .badge{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:6px 10px;font-weight:700;font-size:12px}
  .idleB{background:#e5e7eb}.listenB{background:#dbeafe}.thinkB{background:#fef3c7}.speakB{background:#dcfce7}
  .bubble{background:#eef3ff;padding:12px;border-radius:12px;line-height:1.45;min-height:54px;margin-top:8px}
  .chatlayout{display:grid;grid-template-columns:280px 1fr;gap:14px;align-items:start}
  .hud{border:1px solid #e5e7eb;border-radius:14px;padding:12px}
  .chatlog{max-height:46vh;overflow:auto;border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#f8fafc}
  .utter{margin:6px 0}.who{font-weight:700}.u{color:#0d9488}.b{color:#1d4ed8}
  .panel{margin-top:12px;border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#ffffff}
  textarea{width:100%;min-height:120px;border:1px solid #e5e7eb;border-radius:8px;padding:8px;font-family:monospace}
  .timerWrap{display:grid;place-items:center;margin:8px 0}
  .ring{width:160px;height:160px;border-radius:50%;background:conic-gradient(var(--accent) 0deg, #e5e7eb 0deg)}
  .ringInner{display:grid;place-items:center;width:140px;height:140px;border-radius:50%;background:#fff;margin:10px auto}
  .timeText{font-size:28px;font-weight:800;letter-spacing:1px}
  .label{font-size:12px;color:var(--muted)}
  .wave{display:flex;gap:3px;height:22px;align-items:flex-end}
  .bar{width:4px;background:#2563eb;border-radius:2px;animation:up 1s infinite ease-in-out}
  .bar:nth-child(2){animation-delay:0.1s}.bar:nth-child(3){animation-delay:0.2s}.bar:nth-child(4){animation-delay:0.3s}.bar:nth-child(5){animation-delay:0.4s}
  @keyframes up{0%,100%{height:4px}50%{height:22px}}
  .toast{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:10px;font-size:13px;display:none}
  .toast.show{display:block}
</style>
</head>
<body>
<div class="box">
  <h1 id="title">(책 이름) 큼프리헨션 첵업 앤 디스커스</h1>
  <div class="muted">대화는 영어로 진행되며, 화면 표시는 한글입니다. Safari는 <b>Samantha</b>, Chrome은 <b>Google US English</b> 음성으로 읽습니다.</div>

  <div class="row">
    <button id="start" class="btn">▶ 시작</button>
    <button id="listen-toggle" class="btn">🟢 답변하기 시작</button>
    <button id="repeat" class="btn secondary">⟳ 다시 듣기</button>
    <button id="end" class="btn secondary">⏹ 종료</button>
    <label class="muted" for="voiceSel">목소리:</label>
    <select id="voiceSel" class="select"></select>
  </div>

  <div class="chatlayout">
    <div class="hud" aria-live="polite">
      <div class="label">남은 시간</div>
      <div class="timerWrap">
        <div class="ring" id="ring"><div class="ringInner">
          <div class="timeText" id="time">05:00</div>
        </div></div>
      </div>
      <div class="label">상태</div>
      <div class="status" id="status">
        <span class="badge idleB" id="stateBadge">🟡 대기중</span>
        <div class="wave" id="wave" style="display:none"><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div></div>
      </div>
      <div class="muted" id="turns-left"></div>
    </div>

    <div>
      <div class="bubble" id="bot">준비되었습니다.</div>
      <div class="chatlog" id="log"></div>
      <div class="panel">
        <div class="muted">세션 요약(사용자 클릭 시 생성)</div>
        <textarea id="summary" readonly></textarea>
        <div class="row">
          <button id="download" class="btn secondary">⬇ 요약 다운로드</button>
          <button id="clear" class="btn secondary">🗑 지우기</button>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="toast" id="toast">Connection failed. Please try again later.</div>

<script>
/* ====== 엘리먼트 ====== */
const startBtn=document.getElementById('start');
const listenBtn=document.getElementById('listen-toggle');
const repeatBtn=document.getElementById('repeat');
const endBtn=document.getElementById('end');
const stateBadge=document.getElementById('stateBadge');
const waveEl=document.getElementById('wave');
const botEl=document.getElementById('bot');
const logEl=document.getElementById('log');
const summaryEl=document.getElementById('summary');
const timeEl=document.getElementById('time');
const ringEl=document.getElementById('ring');
const voiceSel=document.getElementById('voiceSel');
const toastEl=document.getElementById('toast');
const titleEl=document.getElementById('title');
const downloadBtn=document.getElementById('download');
const clearBtn=document.getElementById('clear');

/* ====== 상태 ====== */
let recognizing=false, rec=null, mode='IDLE', started=false;
let inFlight=false;
let pendingUtter="";
let history=[]; let lastQuestion="";
let sessionId=(Math.random().toString(36).slice(2)+Date.now().toString(36));

/* ====== 책/질문 (하드코딩 → 나중엔 DB 연동) ====== */
let book = { title: "책 이름", summary:"", chapter:"", characters:"", vocab:"" };
document.title = `(${book.title}) 큼프리헨션 첵업 앤 디스커스`;
titleEl.textContent = `(${book.title}) 큼프리헨션 첵업 앤 디스커스`;

// 기본 5문항(없으면 free 모드로 시작)
let questionList = [
  "Who is the main character? Try to use 'because' in your answer.",
  "Where and how do the main characters meet?",
  "What problem does the character face inside?",
  "Which moment felt most important to you, and why?",
  "If you were the main character, what would you do next?"
];

let phase = questionList.length ? 'guided' : 'free';
let qIndex = 0;

/* ====== 보이스 ====== */
let selectedVoice=null;
function isSafari(){ return /^((?!chrome|android).)*safari/i.test(navigator.userAgent); }
function showToast(){ toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'),2000); }
function loadVoices(){
  const voices=speechSynthesis.getVoices();
  voiceSel.innerHTML="";
  voices.filter(v=>v.lang&&v.lang.startsWith('en')).forEach(v=>{
    const opt=document.createElement('option'); opt.value=v.name; opt.textContent=`${v.name} (${v.lang})`; voiceSel.appendChild(opt);
  });
}
voiceSel.addEventListener('change',()=>{
  const voices=speechSynthesis.getVoices();
  selectedVoice=voices.find(v=>v.name===voiceSel.value)||selectedVoice;
});
async function waitForVoices(timeout=1500){
  return new Promise(resolve=>{
    const start=Date.now();
    const id=setInterval(()=>{
      const v=speechSynthesis.getVoices();
      if(v && v.length){ clearInterval(id); resolve(v); }
      else if(Date.now()-start>timeout){ clearInterval(id); resolve(v); }
    },60);
  });
}
async function initVoicesOnce(){
  const voices=await waitForVoices();
  loadVoices();
  const pick=
    (isSafari()
      ? voices.find(v=>v.name==='Samantha' && v.lang.startsWith('en'))
      : voices.find(v=>v.name==='Google US English' && v.lang.startsWith('en')))
    || voices.find(v=>v.lang==='en-US')
    || voices.find(v=>v.lang && v.lang.startsWith('en'))
    || voices[0];
  selectedVoice = pick || null;
  if(selectedVoice){
    const idx=[...voiceSel.options].findIndex(o=>o.value===selectedVoice.name);
    if(idx>=0) voiceSel.selectedIndex=idx;
  }
}
document.addEventListener('DOMContentLoaded', initVoicesOnce);

/* ====== 배지/읽어주기 ====== */
function setBadge(t){
  if(t==='IDLE'){stateBadge.textContent='🟡 대기중';stateBadge.className='badge idleB';waveEl.style.display='none';}
  if(t==='LISTENING'){stateBadge.textContent='🎤 듣는 중';stateBadge.className='badge listenB';waveEl.style.display='flex';}
  if(t==='THINKING'){stateBadge.textContent='🤔 생각 중';stateBadge.className='badge thinkB';waveEl.style.display='none';}
  if(t==='SPEAKING'){stateBadge.textContent='🗣️ 말하는 중';stateBadge.className='badge speakB';waveEl.style.display='none';}
}
function setMode(m){ mode=m; setBadge(m); }
function speak(text){
  setMode('SPEAKING');
  const u=new SpeechSynthesisUtterance(text);
  u.lang='en-US';
  if(selectedVoice) u.voice=selectedVoice;
  u.onend=()=>setMode('IDLE');
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}
function say(text){ botEl.textContent=text; speak(text); addLog('assistant', text); }
function addLog(role,text){
  const d=document.createElement('div'); d.className='utter';
  const w=document.createElement('span'); w.className='who '+(role==='assistant'?'b':'u'); w.textContent=role==='assistant'?'Bot: ':'You: ';
  const m=document.createElement('span'); m.textContent=text;
  d.appendChild(w); d.appendChild(m); logEl.appendChild(d); logEl.scrollTop=logEl.scrollHeight;
}

/* ====== 타이머(5분) ====== */
const DURATION=300; let startTs=null; let timerHandle=null;
function secondsLeft(){ if(!startTs) return DURATION; const e=Math.floor((Date.now()-startTs)/1000); return Math.max(0,DURATION-e); }
function fmt(s){ const m=Math.floor(s/60), ss=s%60; return `${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}`; }
function setProgress(sec){
  const pct=(sec/DURATION); const deg=Math.max(0,Math.min(360,Math.floor(pct*360)));
  ringEl.style.background=`conic-gradient(var(--accent) ${deg}deg,#e5e7eb ${deg}deg)`;
  if(sec<=10) ringEl.style.background=`conic-gradient(var(--danger) ${deg}deg,#fde2e2 ${deg}deg)`;
  timeEl.textContent=fmt(sec);
}
function startCountdown(){
  if(!startTs){ startTs=Date.now(); localStorage.setItem('hbc_timer_start',String(startTs)); }
  if(timerHandle) clearInterval(timerHandle);
  setProgress(secondsLeft());
  timerHandle=setInterval(()=>{
    const left=secondsLeft(); setProgress(left);
    if(left<=0){
      clearInterval(timerHandle);
      say("Time is up. Session ended. Use '요약 다운로드' to save a summary.");
      stopCountdown();
      localStorage.removeItem('hbc_timer_start');
      listenBtn.disabled=true;
    }
  },1000);
}
(function restoreTimer(){ const t=localStorage.getItem('hbc_timer_start'); if(t){ startTs=parseInt(t,10); startCountdown(); } })();
const saved=localStorage.getItem('hbc_summary'); if(saved) summaryEl.value=saved;
function stopCountdown(){ if(timerHandle) clearInterval(timerHandle); timerHandle=null; }

/* ====== 서버 호출 ====== */
async function callAI(userText){
  if (inFlight) return;
  inFlight = true;
  setMode('THINKING');

  const recent = history.slice(-12);

  try {
    const res = await fetch('/.netlify/functions/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        history: recent,
        user: userText,
        sessionId,
        book,
        // 현재 질문과 남은 질문을 함께 전달
        current_question: lastQuestion || (questionList[qIndex] || ""),
        remainingQuestions: questionList.slice(qIndex)
      })
    });

    const raw = await res.text();

    if (!res.ok) {
      if (res.status === 429 && /insufficient_quota/i.test(raw)) {
        say("Billing credits are depleted. Please recharge and try again.");
      } else {
        say("Connection failed. Please try again later.");
        showToast();
      }
      return;
    }

    function extractBotFields(rawText){
      try{
        const j = JSON.parse(rawText);
        if (j.bot_text || j.next_question) return j;
        const content = j?.choices?.[0]?.message?.content;
        if (typeof content === 'string'){
          try{
            const inner = JSON.parse(content);
            if (inner.bot_text || inner.next_question) return inner;
            return { bot_text: content, next_question: "" };
          }catch{
            return { bot_text: content, next_question: "" };
          }
        }
      }catch{}
      return { bot_text: rawText, next_question: "" };
    }

    const data = extractBotFields(raw);
    const botText = data.bot_text || "";
    const tip     = data.practice_tip ? (" " + data.practice_tip) : "";
    const nextQ   = data.next_question || "";
    lastQuestion  = nextQ || lastQuestion;

    // 피드백 + 다음 질문을 함께 말하기
    const speakText = nextQ ? `${botText}${tip ? ' '+tip : ''} ${nextQ}`
                            : `${botText}${tip ? ' '+tip : ''}`;
    say(speakText);
    history.push({ role:'assistant', content: speakText });

    // advance=true 일 때만 다음 질문으로 진행
    if (data.advance && phase === 'guided' && qIndex < questionList.length) {
      qIndex++;
      if (qIndex >= questionList.length) {
        phase = 'free';
        const kickoff = "Great job! We've finished the questions. Now let's discuss freely — what part surprised you the most?";
        lastQuestion = "What part surprised you the most?";
        say(kickoff);
        history.push({ role:'assistant', content: kickoff });
      }
    }
  } catch (e) {
    console.error(e);
    say("Connection failed. Please try again later.");
    showToast();
  } finally {
    inFlight = false;
  }
}

/* ====== 자동 인식(토글) ====== */
const AUTO_SILENCE_MS = 1200;   // 침묵 시 전송
const MAX_UTTER_MS    = 12000;  // 한 덩어리 최대 길이
const MIN_WORDS       = 3;      // 너무 짧으면 무시
const COOLDOWN_MS     = 1200;   // 연속 호출 쿨다운
const TURN_BUDGET     = 10;     // 세션당 응답 한도

let isListening=false;
let silenceTimer=null, maxTimer=null;
let lastCallAt=0, turnsLeft=TURN_BUDGET;

function showTurnsLeft(){
  const el=document.getElementById('turns-left');
  el.textContent=`남은 AI 응답: ${turnsLeft}`;
}
showTurnsLeft();

function clearTimers(){ if(silenceTimer){clearTimeout(silenceTimer);silenceTimer=null;} if(maxTimer){clearTimeout(maxTimer);maxTimer=null;} }
function armTimers(){ clearTimers(); silenceTimer=setTimeout(commitUtterance, AUTO_SILENCE_MS); maxTimer=setTimeout(commitUtterance, MAX_UTTER_MS); }

function createRecognizer(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){ botEl.textContent='이 브라우저는 음성 인식을 지원하지 않아요. Chrome을 권장합니다.'; return null; }
  const r=new SR();
  r.lang='en-US';
  r.interimResults=false;
  r.continuous=true;

  r.onstart=()=>{ recognizing=true; pendingUtter=""; setMode('LISTENING'); armTimers(); };
  r.onresult=(e)=>{
    const last=e.results[e.results.length-1];
    if(last && last.isFinal){ pendingUtter += (pendingUtter?" ":"") + last[0].transcript.trim(); }
    armTimers();
  };
  r.onerror =()=>{ recognizing=false; setMode('IDLE'); clearTimers(); showToast(); };
  r.onend   =()=>{ recognizing=false; setMode('IDLE'); clearTimers(); if(isListening){ setTimeout(()=>{ try{ r.start(); }catch{} }, 200); } };
  return r;
}

listenBtn.onclick = () => {
  if(!isListening){
    if(!rec) rec=createRecognizer();
    if(!rec) return;
    try{ rec.start(); }catch{}
    isListening=true;
    listenBtn.textContent='⏹ 인식 중지';
  }else{
    try{ rec.stop(); }catch{}
    isListening=false;
    listenBtn.textContent='🟢 답변하기 시작';
  }
};

async function commitUtterance(){
  clearTimers();
  const utter=(pendingUtter||"").trim();
  pendingUtter="";

  const words=utter.split(/\s+/).filter(Boolean);
  if(words.length<MIN_WORDS) return;

  if(turnsLeft<=0){ say("AI response limit reached for this session."); return; }
  const now=Date.now();
  if(now-lastCallAt<COOLDOWN_MS) return;
  lastCallAt=now;
  turnsLeft--; showTurnsLeft();

  try {
    addLog('user', utter);
    history.push({ role:'user', content: utter });
    await callAI(utter);
  } catch (e) {
    console.error(e);
    turnsLeft++; showTurnsLeft(); // 실패 시 복원(선택)
  }

  if(isListening && rec){ setMode('LISTENING'); armTimers(); }
}

/* ====== 첫 질문 로컬 안내(선택) ====== */
function askNextQuestionOnce(){
  if(phase!=='guided') return;
  if(qIndex>=questionList.length){ phase='free'; return; }
  const q = questionList[qIndex];
  lastQuestion = typeof q==='string' ? q : (q?.text ?? String(q));
  const ask = `Question ${qIndex+1}. ${lastQuestion}`;
  addLog('assistant', ask); speak(ask);
}

/* ====== 버튼 ====== */
startBtn.onclick=async ()=>{
  if(started){ say("You’ve already started. We’ll keep going."); return; }
  if(speechSynthesis.getVoices().length===0) await initVoicesOnce();
  started=true; startCountdown();
  const greeting="Hello! You have five minutes. I will give short feedback and follow-up questions. Let's begin!";
  history.push({role:'assistant',content:greeting});
  say(greeting);
  askNextQuestionOnce(); // 첫 질문 안내
};
repeatBtn.onclick=()=>{ if(lastQuestion){ say("I will repeat: "+lastQuestion); } };
endBtn.onclick   =()=>{ say("Session ended. Click '요약 다운로드' if you want a summary."); stopCountdown(); };

/* ====== 요약 다운로드(옵션) ====== */
downloadBtn.onclick = async () => {
  const transcript = history.map(h => `${h.role==='assistant'?'Bot':'You'}: ${h.content}`).join('\n');
  if(!transcript || transcript.trim().length<10){ alert('There isn’t enough content to summarize.'); return; }

  downloadBtn.disabled = true;
  try{
    const res = await fetch('/.netlify/functions/summarize', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ transcript, maxWords: 250, lang: 'ko' })
    });
    const raw = await res.text();
    if(!res.ok){ console.error('Summarize error', res.status, raw); alert('Summary failed'); return; }

    let out;
    try{ const data=JSON.parse(raw); out = data.choices?.[0]?.message?.content?.trim() || raw; }
    catch{ out = raw; }

    const stamp = new Date().toISOString().replace(/[:.]/g,'-');
    downloadTextFile(out, `summary-${stamp}.md`);
  }catch(e){
    console.error(e); alert('Network error');
  }finally{
    downloadBtn.disabled=false;
  }
};
clearBtn.onclick=()=>{ summaryEl.value=""; localStorage.removeItem('hbc_summary'); };

function downloadTextFile(text, filename){
  const blob = new Blob([text], { type:'text/markdown;charset=utf-8' });
  const url  = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>
