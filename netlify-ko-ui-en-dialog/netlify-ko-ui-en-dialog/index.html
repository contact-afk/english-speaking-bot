<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AI ìŠ¤í”¼í‚¹ ë´‡ â€“ 5ë¶„ ëª¨ë“œ (í•œê¸€ UI / ì˜ì–´ ëŒ€í™”)</title>
<style>
  :root{--accent:#2563eb;--good:#10b981;--warn:#f59e0b;--danger:#ef4444;--ink:#0f172a;--muted:#6b7280}
  *{box-sizing:border-box}
  body{font-family:system-ui,Apple SD Gothic Neo,Malgun Gothic,Arial;margin:0;background:#fff;color:var(--ink);display:flex;min-height:100vh;align-items:center;justify-content:center}
  .box{max-width:980px;width:100%;padding:20px}
  h1{font-size:20px;margin:0 0 8px}
  .muted{color:var(--muted);font-size:12px}
  .row{display:flex;gap:8px;margin:10px 0;flex-wrap:wrap;align-items:center}
  .btn{border:0;border-radius:10px;padding:12px 14px;font-weight:700;cursor:pointer;color:#fff;background:#111}
  .btn.secondary{background:#e5e7eb;color:#111}
  .select{border:1px solid #e5e7eb;border-radius:8px;padding:8px 10px;font-size:14px}
  .status{font-size:13px;color:#111;height:20px;margin-top:6px;display:flex;align-items:center;gap:8px}
  .badge{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:6px 10px;font-weight:700;font-size:12px}
  .idleB{background:#e5e7eb}.listenB{background:#dbeafe}.thinkB{background:#fef3c7}.speakB{background:#dcfce7}
  .bubble{background:#eef3ff;padding:12px;border-radius:12px;line-height:1.45;min-height:54px;margin-top:8px}
  .chatlayout{display:grid;grid-template-columns:280px 1fr;gap:14px;align-items:start}
  .hud{border:1px solid #e5e7eb;border-radius:14px;padding:12px}
  .chatlog{max-height:46vh;overflow:auto;border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#f8fafc}
  .utter{margin:6px 0}.who{font-weight:700}.u{color:#0d9488}.b{color:#1d4ed8}
  .panel{margin-top:12px;border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#ffffff}
  textarea{width:100%;min-height:120px;border:1px solid #e5e7eb;border-radius:8px;padding:8px;font-family:monospace}
  .timerWrap{display:grid;place-items:center;margin:8px 0}
  .ring{width:160px;height:160px;border-radius:50%;background:conic-gradient(var(--accent) 0deg, #e5e7eb 0deg)}
  .ringInner{display:grid;place-items:center;width:140px;height:140px;border-radius:50%;background:#fff;margin:10px auto}
  .timeText{font-size:28px;font-weight:800;letter-spacing:1px}
  .label{font-size:12px;color:var(--muted)}
  .wave{display:flex;gap:3px;height:22px;align-items:flex-end}
  .bar{width:4px;background:#2563eb;border-radius:2px;animation:up 1s infinite ease-in-out}
  .bar:nth-child(2){animation-delay:0.1s}.bar:nth-child(3){animation-delay:0.2s}.bar:nth-child(4){animation-delay:0.3s}.bar:nth-child(5){animation-delay:0.4s}
  @keyframes up{0%,100%{height:4px}50%{height:22px}}
  .toast{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:10px;font-size:13px;display:none}
  .toast.show{display:block}
</style>
</head>
<body>
<div class="box">
  <h1>AI ìŠ¤í”¼í‚¹ ë´‡ â€“ 5ë¶„ ëª¨ë“œ (í•œê¸€ UI / ì˜ì–´ ëŒ€í™”)</h1>
  <div class="muted">ëŒ€í™”ëŠ” ì˜ì–´ë¡œ ì§„í–‰ë˜ë©°, í™”ë©´ í‘œì‹œëŠ” í•œê¸€ì…ë‹ˆë‹¤. SafariëŠ” <b>Samantha</b>, Chromeì€ <b>Google US English</b> ìŒì„±ìœ¼ë¡œ ì½ìŠµë‹ˆë‹¤.</div>

  <div class="row">
    <button id="start" class="btn">â–¶ ì‹œì‘</button>
    <!-- ğŸ¤ êµ¬ê°„ ì œì–´ -->
    <button id="speak-start" class="btn">ğŸŸ¢ ë‹µë³€í•˜ê¸° ì‹œì‘</button>
    <button id="speak-stop"  class="btn secondary" disabled>â›” ë‹µë³€í•˜ê¸° ë</button>

    <button id="repeat" class="btn secondary">âŸ³ ë‹¤ì‹œ ë“£ê¸°</button>
    <button id="end" class="btn secondary">â¹ ì¢…ë£Œ</button>
    <label class="muted" for="voiceSel">ëª©ì†Œë¦¬:</label>
    <select id="voiceSel" class="select"></select>
  </div>

  <div class="chatlayout">
    <div class="hud" aria-live="polite">
      <div class="label">ë‚¨ì€ ì‹œê°„</div>
      <div class="timerWrap">
        <div class="ring" id="ring"><div class="ringInner">
          <div class="timeText" id="time">05:00</div>
        </div></div>
      </div>
      <div class="label">ìƒíƒœ</div>
      <div class="status" id="status">
        <span class="badge idleB" id="stateBadge">ğŸŸ¡ ëŒ€ê¸°ì¤‘</span>
        <div class="wave" id="wave" style="display:none"><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div></div>
      </div>
    </div>

    <div>
      <div class="bubble" id="bot">ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
      <div class="chatlog" id="log"></div>
      <div class="panel">
        <div class="muted">ì„¸ì…˜ ìš”ì•½(ì‚¬ìš©ì í´ë¦­ ì‹œ ìƒì„±)</div>
        <textarea id="summary" readonly></textarea>
        <div class="row">
          <button id="download" class="btn secondary">â¬‡ ìš”ì•½ ë‹¤ìš´ë¡œë“œ</button>
          <button id="clear" class="btn secondary">ğŸ—‘ ì§€ìš°ê¸°</button>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="toast" id="toast">Connection failed.</div>

<script>
/* ---------- ì—˜ë¦¬ë¨¼íŠ¸ ---------- */
const startBtn=document.getElementById('start');
const speakStartBtn=document.getElementById('speak-start');
const speakStopBtn =document.getElementById('speak-stop');
const repeatBtn   =document.getElementById('repeat');
const endBtn      =document.getElementById('end');
const stateBadge=document.getElementById('stateBadge');
const waveEl=document.getElementById('wave');
const botEl=document.getElementById('bot');
const logEl=document.getElementById('log');
const summaryEl=document.getElementById('summary');
const timeEl=document.getElementById('time');
const ringEl=document.getElementById('ring');
const voiceSel=document.getElementById('voiceSel');
const toastEl=document.getElementById('toast');
const downloadBtn=document.getElementById('download');
const clearBtn=document.getElementById('clear');

/* ---------- ìƒíƒœ ---------- */
let recognizing=false, rec=null, mode='IDLE', started=false;
let inFlight=false;           // API ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
let pendingUtter="";          // ë‹µë³€ êµ¬ê°„ì˜ ìµœì¢… í…ìŠ¤íŠ¸
let history=[]; let lastQuestion="";
let sessionId=(Math.random().toString(36).slice(2)+Date.now().toString(36));

/* ---------- ìë™ ì¢…ë£Œ(ë§ ë ë²„íŠ¼ ì•ˆ ëˆŒëŸ¬ë„ ì•ˆì „) ---------- */
const AUTO_SILENCE_MS = 1500;  // ì¹¨ë¬µ ì§€ì† ì‹œ ìë™ ì¢…ë£Œ
const MAX_TALK_MS     = 12000; // ìµœëŒ€ ë°œí™” ì‹œê°„
let silenceTimer=null, hardStopTimer=null;
function clearTimers(){ if(silenceTimer){clearTimeout(silenceTimer);silenceTimer=null;} if(hardStopTimer){clearTimeout(hardStopTimer);hardStopTimer=null;} }
function armAutoStop(){
  clearTimers();
  silenceTimer = setTimeout(()=>{ try{ if(recognizing && rec) rec.stop(); }catch{} }, AUTO_SILENCE_MS);
  hardStopTimer = setTimeout(()=>{ try{ if(recognizing && rec) rec.stop(); }catch{} }, MAX_TALK_MS);
}

/* ---------- ì±… ì •ë³´ & ì§ˆë¬¸ ë¦¬ìŠ¤íŠ¸(ì˜ˆì‹œ) ---------- */
const book = {
  title: "Because of Winn-Dixie",
  summary: "A girl named Opal adopts a stray dog, which helps her make friends and heal.",
  chapter: "Ch.1â€“3",
  characters: "Opal, her father, Winn-Dixie",
  vocab: "adopt, preacher, stray",
};
const questionList = [
  "Who is the main character and what is she like?",
  "How did Opal meet Winn-Dixie?",
  "Which moment felt most important to you, and why?",
  "What problem is Opal facing inside?",
  "If you were Opal, what would you do next?"
];

/* ---------- ë³´ì´ìŠ¤ ---------- */
let selectedVoice=null;
function isSafari(){ return /^((?!chrome|android).)*safari/i.test(navigator.userAgent); }
function showToast(){ toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'),2000); }
function loadVoices(){
  const voices=speechSynthesis.getVoices();
  voiceSel.innerHTML="";
  voices.filter(v=>v.lang&&v.lang.startsWith('en')).forEach(v=>{
    const opt=document.createElement('option'); opt.value=v.name; opt.textContent=`${v.name} (${v.lang})`; voiceSel.appendChild(opt);
  });
  const preferred=isSafari()?'Samantha':'Google US English';
  const def=voices.find(v=>v.name===preferred&&v.lang.startsWith('en'));
  const fallback=voices.find(v=>v.lang==='en-US')||voices.find(v=>v.lang&&v.lang.startsWith('en'))||voices[0];
  selectedVoice=def||fallback;
  if(selectedVoice){
    const idx=Array.from(voiceSel.options).findIndex(o=>o.value===selectedVoice.name);
    if(idx>=0) voiceSel.selectedIndex=idx;
  }
}
speechSynthesis.onvoiceschanged=loadVoices;
voiceSel.addEventListener('change',()=>{ const voices=speechSynthesis.getVoices(); selectedVoice=voices.find(v=>v.name===voiceSel.value)||selectedVoice; });

/* ---------- ë°°ì§€ ---------- */
function setBadge(t){
  if(t==='IDLE'){stateBadge.textContent='ğŸŸ¡ ëŒ€ê¸°ì¤‘';stateBadge.className='badge idleB';waveEl.style.display='none';}
  if(t==='LISTENING'){stateBadge.textContent='ğŸ¤ ë“£ëŠ” ì¤‘';stateBadge.className='badge listenB';waveEl.style.display='flex';}
  if(t==='THINKING'){stateBadge.textContent='ğŸ¤” ìƒê° ì¤‘';stateBadge.className='badge thinkB';waveEl.style.display='none';}
  if(t==='SPEAKING'){stateBadge.textContent='ğŸ—£ï¸ ë§í•˜ëŠ” ì¤‘';stateBadge.className='badge speakB';waveEl.style.display='none';}
}
function setMode(m){ mode=m; setBadge(m); }

/* ---------- ë§í•˜ê¸°(ì½ì–´ì£¼ê¸°) ---------- */
function speak(text){
  setMode('SPEAKING');
  const u=new SpeechSynthesisUtterance(text);
  u.lang='en-US';
  if(selectedVoice) u.voice=selectedVoice;
  u.onend=()=>setMode('IDLE');
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}
function say(text){ botEl.textContent=text; speak(text); addLog('assistant', text); }
function addLog(role,text){
  const d=document.createElement('div'); d.className='utter';
  const w=document.createElement('span'); w.className='who '+(role==='assistant'?'b':'u'); w.textContent=role==='assistant'?'Bot: ':'You: ';
  const m=document.createElement('span'); m.textContent=text;
  d.appendChild(w); d.appendChild(m); logEl.appendChild(d); logEl.scrollTop=logEl.scrollHeight;
}

/* ---------- íƒ€ì´ë¨¸(5ë¶„) ---------- */
const DURATION=300; let startTs=null; let timerHandle=null;
function secondsLeft(){ if(!startTs) return DURATION; const e=Math.floor((Date.now()-startTs)/1000); return Math.max(0,DURATION-e); }
function fmt(s){ const m=Math.floor(s/60), ss=s%60; return `${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}`; }
function setProgress(sec){
  const pct=(sec/DURATION); const deg=Math.max(0,Math.min(360,Math.floor(pct*360)));
  ringEl.style.background=`conic-gradient(var(--accent) ${deg}deg,#e5e7eb ${deg}deg)`;
  if(sec<=10) ringEl.style.background=`conic-gradient(var(--danger) ${deg}deg,#fde2e2 ${deg}deg)`;
  timeEl.textContent=fmt(sec);
}
function startCountdown(){
  if(!startTs){ startTs=Date.now(); localStorage.setItem('hbc_timer_start',String(startTs)); }
  if(timerHandle) clearInterval(timerHandle);
  setProgress(secondsLeft());
  timerHandle=setInterval(()=>{
    const left=secondsLeft(); setProgress(left);
    if(left<=0){
      clearInterval(timerHandle);
      say("Time is up. Session ended. Use 'ìš”ì•½ ë‹¤ìš´ë¡œë“œ' to save a summary.");
      stopCountdown();
      localStorage.removeItem('hbc_timer_start');
      speakStartBtn.disabled=true; speakStopBtn.disabled=true;
    }
  },1000);
}
(function restoreTimer(){ const t=localStorage.getItem('hbc_timer_start'); if(t){ startTs=parseInt(t,10); startCountdown(); } })();
const saved=localStorage.getItem('hbc_summary'); if(saved) summaryEl.value=saved;
function stopCountdown(){ if(timerHandle) clearInterval(timerHandle); timerHandle=null; }

/* ---------- ì„œë²„ í˜¸ì¶œ ---------- */
async function callAI(userText){
  if(inFlight) return;
  inFlight = true;
  setMode('THINKING');
  const recent=history.slice(-12);
  try{
    const res=await fetch('/.netlify/functions/chat',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ history:recent, user:userText, sessionId, book, questionList })
    });
    const raw = await res.text();

    if(!res.ok){
      if(res.status===429 && /insufficient_quota/i.test(raw)){
        say("Billing credits are depleted. Please recharge and try again.");
      }else{
        say("Connection failed. Please try again later.");
        showToast();
      }
      return;
    }

    // ---- ì‘ë‹µ ë³´ì •: {bot_text,...} ë˜ëŠ” completion JSON ëª¨ë‘ ì²˜ë¦¬
    function extractBotFields(rawText){
      try{
        const j = JSON.parse(rawText);
        if (j.bot_text || j.next_question) return j;
        const content = j?.choices?.[0]?.message?.content;
        if (typeof content === 'string'){
          try{
            const inner = JSON.parse(content);
            if (inner.bot_text || inner.next_question) return inner;
            return { bot_text: content, next_question: "" };
          }catch{
            return { bot_text: content, next_question: "" };
          }
        }
      }catch{}
      return { bot_text: rawText, next_question: "" };
    }

    const data = extractBotFields(raw);
    const botText = data.bot_text || "";
    const tip     = data.practice_tip ? (" " + data.practice_tip) : "";
    lastQuestion  = data.next_question || "";

    say(botText + tip);
    history.push({ role:'assistant', content: botText + tip });
  }catch(e){
    console.error(e);
    say("Connection failed. Please try again later.");
    showToast();
  }finally{
    inFlight = false;
  }
}

/* ---------- ìŒì„± ì¸ì‹: â€˜ë‹µë³€í•˜ê¸° ì‹œì‘/ëâ€™ + ìë™ ì¢…ë£Œ ---------- */
function initASR(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){ botEl.textContent='ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•Šì•„ìš”. Chromeì„ ê¶Œì¥í•©ë‹ˆë‹¤.'; return null; }
  const r=new SR();
  r.lang='en-US';
  r.interimResults=false;     // ì¤‘ê°„ ê²°ê³¼ ë¬´ì‹œ
  r.continuous=true;          // ì‹œì‘~ë êµ¬ê°„ ë™ì•ˆ ì—°ì† ìˆ˜ì§‘

  r.onstart=()=>{ recognizing=true; pendingUtter=""; setMode('LISTENING'); armAutoStop(); };
  r.onresult=(e)=>{
    const last=e.results[e.results.length-1];
    if(last && last.isFinal){ pendingUtter += (pendingUtter?" ":"") + last[0].transcript.trim(); }
    armAutoStop();
  };
  r.onerror =()=>{ recognizing=false; setMode('IDLE'); showToast(); clearTimers(); };
  r.onend   =()=>{                // ìë™/ìˆ˜ë™ ì¢…ë£Œ ê³µí†µ
    recognizing=false; setMode('IDLE'); clearTimers();

    // âœ… ìˆ˜ë™ ì¢…ë£Œë¼ë©´ speakStopBtn.disabled === true (onclickì—ì„œ ì´ë¯¸ ì²˜ë¦¬)
    if (speakStopBtn.disabled) return;

    // âœ… ìë™ ì¢…ë£Œ(ì¹¨ë¬µ/ìµœëŒ€ì‹œê°„) ì²˜ë¦¬
    speakStartBtn.disabled=false;
    speakStopBtn.disabled =true;

    const utter=(pendingUtter||"").trim();
    if(!utter || utter.split(/\s+/).length<3) return;
    addLog('user', utter);
    history.push({ role:'user', content: utter });
    callAI(utter);
  };

  return r;
}

/* ---------- ë²„íŠ¼ í•¸ë“¤ëŸ¬ ---------- */
startBtn.onclick=()=>{
  if(started){ say("ì´ë¯¸ ì‹œì‘í–ˆì–´ìš”. ê³„ì† ì§„í–‰í• ê²Œìš”."); return; }
  if(speechSynthesis.onvoiceschanged!==undefined){ speechSynthesis.getVoices(); }
  started=true; rec=initASR(); startCountdown();
  const greeting="Hello! You have five minutes. I will give short feedback and follow-up questions. Let's begin!";
  history.push({role:'assistant',content:greeting});
  say(greeting);
};

speakStartBtn.onclick=()=>{  // ğŸŸ¢ ë‹µë³€í•˜ê¸° ì‹œì‘
  if(!rec || secondsLeft()<=0) return;
  try{ rec.start(); speakStartBtn.disabled=true; speakStopBtn.disabled=false; armAutoStop(); }catch(_){}
};

speakStopBtn.onclick=()=>{   // â›” ë‹µë³€í•˜ê¸° ë (ìˆ˜ë™ ì¢…ë£Œ)
  if(!rec) return;
  try{ rec.stop(); }catch(_){}
  clearTimers();
  speakStartBtn.disabled=false; speakStopBtn.disabled=true;

  const utter=(pendingUtter||"").trim();
  if(!utter || utter.split(/\s+/).length<3){ setMode('IDLE'); return; }
  addLog('user', utter);
  history.push({ role:'user', content: utter });
  callAI(utter);
};

repeatBtn.onclick=()=>{ if(lastQuestion){ say("I will repeat: "+lastQuestion); } };
endBtn.onclick   =()=>{ say("Session ended. Click 'ìš”ì•½ ë‹¤ìš´ë¡œë“œ' if you want a summary."); stopCountdown(); };

/* ---------- ìš”ì•½ ë‹¤ìš´ë¡œë“œ(ë²„íŠ¼ í´ë¦­ ì‹œ) ---------- */
downloadBtn.onclick = async () => {
  const transcript = history.map(h => `${h.role==='assistant'?'Bot':'You'}: ${h.content}`).join('\n');
  if(!transcript || transcript.trim().length<10){ alert('ìš”ì•½í•  ëŒ€í™” ë‚´ìš©ì´ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }

  downloadBtn.disabled = true;
  try{
    const res = await fetch('/.netlify/functions/summarize', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ transcript, maxWords: 250, lang: 'ko' })
    });
    const raw = await res.text();
    if(!res.ok){ console.error('Summarize error', res.status, raw); alert(`ìš”ì•½ ì‹¤íŒ¨(${res.status})`); return; }

    let out;
    try{ const data=JSON.parse(raw); out = data.choices?.[0]?.message?.content?.trim() || raw; }
    catch{ out = raw; }

    const stamp = new Date().toISOString().replace(/[:.]/g,'-');
    downloadTextFile(out, `summary-${stamp}.md`);
  }catch(e){
    console.error(e); alert('Network error');
  }finally{
    downloadBtn.disabled=false;
  }
};
clearBtn.onclick=()=>{ summaryEl.value=""; localStorage.removeItem('hbc_summary'); };

function downloadTextFile(text, filename){
  const blob = new Blob([text], { type:'text/markdown;charset=utf-8' });
  const url  = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>
